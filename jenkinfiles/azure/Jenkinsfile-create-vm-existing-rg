pipeline {
    agent any
    parameters {
        string(name: 'VM_NAME', defaultValue: 'test', description: 'Azure virtual machine name prefix')
        string(name: 'VM_USERNAME', defaultValue: 'azureuser', description: 'Azure virtual machine username')
        password(name: 'VM_PASSWORD', defaultValue: 'DEfaultpass#$#123', description: 'Azure virtual machine password')
        choice(name: 'VM_IMAGE', choices: ['Ubuntu2204'], description: 'Azure virtual machine image name')
        choice(name: 'VM_SIZE', choices: ['standard_d2s_v4', 'standard_d2s_v5'], description: 'Azure virtual machine size')
        string(name: 'VM_COUNT', defaultValue: '1', description: 'Number of azure virtual machines to create')
    }
    environment {
        VM_NAME = "dev-agent"
    }
    stages {
        stage('Verify azure credential') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'azure-credential', usernameVariable: 'AZURE_USERNAME', passwordVariable: 'AZURE_PASSWORD')]) {
                  sh 'az login -u ${AZURE_USERNAME} -p ${AZURE_PASSWORD}'
                }
                script {
                    RG_NAME = sh(script: "az group list --query \"[0].name\"", returnStdout: true).trim()
                    echo "Azure Resource group name is : ${RG_NAME}"
                    vmCount = Integer.parseInt("${params.VM_COUNT}")
                    for(int index_no = 0;index_no<vmCount;index_no++) {
                        sh """
                            az vm create \
                              --resource-group ${RG_NAME} \
                              --name ${params.VM_NAME}-${index_no} \
                              --image ${params.VM_IMAGE} \
                              --authentication-type password \
                              --size ${params.VM_SIZE} \
                              --public-ip-sku Standard \
                              --admin-username ${params.VM_USERNAME} \
                              --admin-password ${params.VM_PASSWORD}
                        """
                    }
                }
            }
        }
    }
}
